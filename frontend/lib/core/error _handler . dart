import 'dart:io';
import 'package:dio/dio.dart';

class AppError {
  final String message;
  final ErrorType type;
  final dynamic originalError;
  
  AppError({
    required this.message,
    required this.type,
    this.originalError,
  });
  
  @override
  String toString() => '[$type] $message';
}

enum ErrorType {
  network,
  server,
  authentication,
  authorization,
  validation,
  notFound,
  timeout,
  unknown,
}

class ErrorHandler {
  static AppError handle(dynamic error) {
    if (error is DioException) {
      return _handleDioError(error);
    } else if (error is SocketException) {
      return AppError(
        message: 'خطای اتصال به اینترنت',
        type: ErrorType.network,
        originalError: error,
      );
    } else if (error is FormatException) {
      return AppError(
        message: 'خطای فرمت داده',
        type: ErrorType.validation,
        originalError: error,
      );
    } else if (error is TypeError) {
      return AppError(
        message: 'خطای نوع داده',
        type: ErrorType.validation,
        originalError: error,
      );
    }
    
    return AppError(
      message: error.toString(),
      type: ErrorType.unknown,
      originalError: error,
    );
  }
  
  static AppError _handleDioError(DioException error) {
    switch (error.type) {
      case DioExceptionType.connectionTimeout:
      case DioExceptionType.sendTimeout:
      case DioExceptionType.receiveTimeout:
        return AppError(
          message: 'اتصال به سرور timeout شد',
          type: ErrorType.timeout,
          originalError: error,
        );
        
      case DioExceptionType.connectionError:
        return AppError(
          message: 'خطای اتصال به اینترنت',
          type: ErrorType.network,
          originalError: error,
        );
        
      case DioExceptionType.badResponse:
        return _handleResponseError(error.response!);
        
      case DioExceptionType.cancel:
        return AppError(
          message: 'درخواست لغو شد',
          type: ErrorType.unknown,
          originalError: error,
        );
        
      case DioExceptionType.badCertificate:
        return AppError(
          message: 'گواهی SSL معتبر نیست',
          type: ErrorType.authentication,
          originalError: error,
        );
        
      case DioExceptionType.unknown:
        return AppError(
          message: 'خطای نامشخص شبکه',
          type: ErrorType.unknown,
          originalError: error,
        );
    }
  }
  
  static AppError _handleResponseError(Response response) {
    final statusCode = response.statusCode;
    final data = response.data;
    String message = 'خطای سرور';
    
    // استخراج پیام خطا از پاسخ
    if (data is Map) {
      message = data['message']?.toString() ??
                data['error']?.toString() ??
                'خطای سرور';
    }
    
    switch (statusCode) {
      case 400:
        return AppError(
          message: 'درخواست نامعتبر: $message',
          type: ErrorType.validation,
          originalError: data,
        );
        
      case 401:
        return AppError(
          message: 'لطفاً دوباره وارد شوید',
          type: ErrorType.authentication,
          originalError: data,
        );
        
      case 403:
        return AppError(
          message: 'دسترسی غیرمجاز',
          type: ErrorType.authorization,
          originalError: data,
        );
        
      case 404:
        return AppError(
          message: 'منبع مورد نظر یافت نشد',
          type: ErrorType.notFound,
          originalError: data,
        );
        
      case 422:
        final errors = _extractValidationErrors(data);
        return AppError(
          message: errors.isNotEmpty ? errors.join('\n') : 'خطای اعتبارسنجی',
          type: ErrorType.validation,
          originalError: data,
        );
        
      case 429:
        return AppError(
          message: 'تعداد درخواست‌ها بیش از حد مجاز است',
          type: ErrorType.authorization,
          originalError: data,
        );
        
      case 500:
      case 502:
      case 503:
      case 504:
        return AppError(
          message: 'خطای سرور، لطفاً بعداً تلاش کنید',
          type: ErrorType.server,
          originalError: data,
        );
        
      default:
        return AppError(
          message: 'خطای سرور (کد: $statusCode)',
          type: ErrorType.server,
          originalError: data,
        );
    }
  }
  
  static List<String> _extractValidationErrors(dynamic data) {
    final errors = <String>[];
    
    if (data is Map) {
      final errorData = data['errors'] ?? data['data'];
      
      if (errorData is Map) {
        errorData.forEach((key, value) {
          if (value is List) {
            errors.add('${_translateFieldName(key)}: ${value.join(', ')}');
          } else if (value is String) {
            errors.add('${_translateFieldName(key)}: $value');
          }
        });
      }
    }
    
    return errors;
  }
  
  static String _translateFieldName(String field) {
    final translations = {
      'email': 'ایمیل',
      'password': 'رمز عبور',
      'name': 'نام',
      'phone': 'تلفن',
      'title': 'عنوان',
      'description': 'توضیحات',
      'price': 'قیمت',
      'category': 'دسته‌بندی',
      'location': 'موقعیت',
    };
    
    return translations[field] ?? field;
  }
  
  // تابع کمکی برای نمایش خطا به کاربر
  static String getUserFriendlyMessage(AppError error) {
    switch (error.type) {
      case ErrorType.network:
        return 'خطای اتصال به اینترنت. لطفاً اتصال خود را بررسی کنید.';
        
      case ErrorType.server:
        return 'خطای سرور. لطفاً بعداً تلاش کنید.';
        
      case ErrorType.authentication:
        return 'لطفاً دوباره وارد حساب کاربری خود شوید.';
        
      case ErrorType.authorization:
        return 'شما اجازه دسترسی به این بخش را ندارید.';
        
      case ErrorType.validation:
        return error.message;
        
      case ErrorType.notFound:
        return 'مورد درخواستی یافت نشد.';
        
      case ErrorType.timeout:
        return 'اتصال timeout شد. لطفاً دوباره تلاش کنید.';
        
      case ErrorType.unknown:
        return 'خطای نامشخص رخ داد: ${error.message}';
    }
  }
}
